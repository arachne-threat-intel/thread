{# NOTICE: As required by the Apache License v2.0, this notice is to state this file has been modified by Arachne Digital #}

{% extends 'base.html' %}

{% block head %}
{{ super() }}
{% if js_src_online %}{# Edit-report page is the only page which uses pdfmake so import here #}
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.4/pdfmake.min.js" integrity="sha512-vCaf5rysVLu1/zVMefJew+IjqlQibggltPWqeo96XsdyJ4ihR3eEDV1oU60afiRXTGf8DqKUjLs2Q99HCbnjAw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.4/vfs_fonts.min.js" integrity="sha512-BDZ+kFMtxV2ljEa7OWUu0wuay/PAsJ2yeRsBegaSgdUhqIno33xmD9v3m+a2M3Bdn5xbtJtsJ9sSULmNBjCgYw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
{% else %}
  <script src="{{static_url}}scripts/pdfmake.min.js"></script>
  <script src="{{static_url}}scripts/vfs_fonts.js"></script>
{% endif %}
<script id="arachneVfsJson" data-json-path="{{static_url}}misc/arachne_vfs.json"></script>
{% endblock %}

{% block content %}
<br>
<h3 class="display-4 text-center">{{ file }}</h3>

<div class="row justify-content-center pb-3">
  <div class="col-md-auto">
    <button onclick="$.getJSON('{{pdf_link}}', (x) => {downloadPDF(x);})" class="btn btn-md btn-outline-secondary">Export PDF</button>
  </div>
  <div class="col-md-auto">
    <button class="btn btn-md btn-outline-secondary dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Export Navigator JSON</button>
    <div class="dropdown-menu" id="dropdownMenu" aria-labelledby="dropdownMenuButton">
      <h6 class="dropdown-header">Enterprise Layer</h6>
      <a class="dropdown-item" onclick="$.getJSON('{{nav_link}}', (x) => {downloadLayer(x);})">download</a>
    </div>
  </div>
</div>

<div class="row">
  <div class="col reportSentencesDiv">
    {% for elmt in final_html %}
      {% if elmt.tag == 'img' %}
        <img src="{{elmt.text}}" id="img{{elmt.uid}}" class="reportImage" onclick="sentenceContext('{{elmt.uid}}')"> <br class="elmtRelated{{elmt.uid}}"><br class="elmtRelated{{elmt.uid}}">
      {% elif elmt.tag == 'header' %}
        <h3>{{elmt.text}}</h3>
      {% elif elmt.tag == 'li' and elmt.found_status %}
        <li class="elmtRelated{{elmt.uid}}"><span class="bg-warning report-sentence" id="elmt{{elmt.uid}}" onclick="sentenceContext('{{elmt.uid}}')">{{elmt.text}}</span></li> <br class="elmtRelated{{elmt.uid}}">
      {% elif elmt.tag == 'li' %}
        <li class="elmtRelated{{elmt.uid}}"><span id="elmt{{elmt.uid}}" class="report-sentence" onclick="sentenceContext('{{elmt.uid}}')">{{elmt.text}}</span></li> <br class="elmtRelated{{elmt.uid}}">
      {% elif elmt.found_status %}
        <span class="bg-warning report-sentence" id="elmt{{elmt.uid}}" onclick="sentenceContext('{{elmt.uid}}')">{{elmt.text}}</span> <br class="elmtRelated{{elmt.uid}}"><br class="elmtRelated{{elmt.uid}}">
      {% else %}
        <span class="report-sentence" id="elmt{{elmt.uid}}" onclick="sentenceContext('{{elmt.uid}}')">{{elmt.text}}</span> <br class="elmtRelated{{elmt.uid}}"><br class="elmtRelated{{elmt.uid}}">
      {% endif %}
    {% endfor %}
  </div>
  <div class="col col-sm-4 ">
    <div class='missingTechniquesView' id='sentenceContextSection'>
      {% if help_text %}{# Add any help-text to the side-panel of the report (so it is always visible) #}
        <span><b>{{help_text}}</b></span><hr>
      {% endif %}
      {% if completed == 0 %}
        <span class='spanMissingTechniqueView'>Techniques Found</span>
        <br><br>
        <div id="sentenceInformation">
          <table id="tableSentenceInfo" class="table"><tbody></tbody></table>
        </div>
        <br><br>
      {% endif %}
      <span class='spanMissingTechniqueView'>Confirmed Techniques</span>
      <br><br>
      <div id="confirmedsentenceInformation">
        <table id="confirmedSentenceInfo" class="table"><tbody></tbody></table>
      </div>
      <hr><br><br>
      {% if completed == 0 %}
        <span class='spanAddMissingTechnique'>Add A Missing Technique</span>
        <br><br>
        <select id="missingTechniqueSelect" class="selectpicker" data-show-subtext="true" data-size="5"
                data-live-search="true" title="Select a technique">
          {% for tech in attack_uids %}
            {% if tech.parent_name %}
              <option class="missingTechOpt" style="overflow: auto" value="{{tech.uid}}"
                      data-subtext="{{tech.name}}">{{tech.parent_name}}</option>
            {% else %}
              <option class="missingTechOpt" style="overflow: auto" value="{{tech.uid}}">{{tech.name}}</option>
            {% endif %}
          {% endfor %}
        </select>
        <br><br>
        <button disabled id="missingTechBtn" onclick="addMissingTechnique()" class="btn btn-md btn-outline-primary">Add Technique</button> <br><br>
        <button disabled id="delSenBtn" onclick="remove_sentence()" class="btn btn-md btn-danger">Remove Selected</button> <br><br>
        <button onclick="finish_analysis('{{title_quoted}}')" class="btn btn-md btn-success">Finish Analysis</button> <br><br>
      {% endif %}
    </div>
    <br><br>
    <br><br>
  </div>
</div>
{% endblock %}
